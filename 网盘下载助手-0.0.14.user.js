// ==UserScript==
// @namespace Tampermonkey
// @name 网盘下载助手
// @version 0.0.14
// @license MIT
// @homepage http://hd2a.neocities.org
// @downloadURL http://140.245.52.124/tampermonkey/min.baidu.user.js
// @match https://*.bilibili.com/*
// @match https://pan.baidu.com/*
// @match https://v.qq.com/*
// @match https://www.123pan.cn/*
// @match https://www.123pan.com/*
// @connect 220.205.16.51
// @connect localhost
// @connect *
// @noframes
// @grant GM_info
// @grant GM_cookie
// @grant GM_addStyle
// @grant GM_download
// @grant GM_xmlhttpRequest
// @grant GM_openInTab
// @grant GM_getValue
// @grant GM_setValue
// @grant GM_setClipboard
// @grant unsafeWindow
// @grant window.onurlchange
// @run-at document-body
// ==/UserScript==
const u={host:()=>location.hostname.split(".").slice(-2).join("_"),now:()=>Math.floor(Date.now()/1e3),uid:()=>Date.now().toString(36).toUpperCase(),inone:(t,e)=>e.some(e=>t.includes(e)),inall:(t,e)=>e.every(e=>t.includes(e)),tpl:(e,t)=>(Array.isArray(t)?t:[t]).map(i=>e.replaceAll(/\[([a-z]{2,12})]/g,(e,t)=>Object.hasOwn(i,t)?i[t]:t)).join(""),fixurl:e=>(e.startsWith("http")?e:e.startsWith("//")?`${location.protocol}${e}`:e.startsWith("/")?`${location.origin}${e}`:`${location.origin}${location.pathname}/${e}`).replaceAll(/\/+/g,"/"),rand:e=>Math.floor(1e3*Math.random())%(e??9),serialize:e=>"object"==typeof e?new URLSearchParams(Object.entries(e)).toString():e,usp:e=>e?Object.fromEntries(new URLSearchParams(e)):null,xpath:e=>document.evaluate(e,document).iterateNext(),ajax:i=>new Promise(t=>{const e="string"==typeof i?{url:i}:i;e.method=Object.hasOwn(e,"data")?"POST":"GET",GM_xmlhttpRequest(Object.assign({timeout:3e4,onerror:()=>{t({code:1,message:"\u8fde\u63a5\u5931\u8d25"})},ontimeout:()=>{t({code:1,message:"\u8fde\u63a5\u8d85\u65f6"})},onload:e=>{box.hat=e.responseHeaders,t(box.hat.includes("json")?JSON.parse(e.responseText):e.responseText)}},e))}),aria2:t=>{if(t?.url&&Array.isArray(t.url)){let e={id:u.uid(),method:"aria2.addUri",params:[]};box.aria2?.token&&e.params.push("token:"+box.aria2.token),e.params.push(t.url),t?.info&&e.params.push(t.info),GM_xmlhttpRequest({url:box.aria2.jsonrpc,method:"POST",timeout:5e3,data:JSON.stringify(e)})}},dialog:e=>{let t=document.querySelector("#liveDialog");null==t&&((t=document.createElement("dialog")).id="liveDialog",document.body.appendChild(t),t.addEventListener("click",e=>{e.target==e.currentTarget&&(e.preventDefault(),e.stopPropagation(),e.target.close(),e.target.style.display="none")}),setTimeout(()=>{let e=document.activeElement;"BODY"!=e.tagName&&e.blur()},200)),t.open||(t.style.cssText="display: unset",t.showModal()),e instanceof HTMLElement?(t.innerHTML="",t.appendChild(e)):t.innerHTML=e.toString()},dcopy:e=>{let t=null;return e instanceof HTMLElement&&(t=e.cloneNode(true),e.after(t),e.remove()),t},fixcookie:e=>{const t=new Map((e??=[]).map(e=>[e.name,e.value]));return Array.from(t).map(e=>e.join("=")).join("; ")},pwd:t=>{t??=4;let i=[];for(let e=0;e<t;e++)i.push("abcdefghijklmnopqrstuvwxyz23456789ABCDEFGHKLMNPSTVWXY"[Math.floor(1e3*Math.random())%53]);return i.join("")},xdialog:e=>{e instanceof MouseEvent&&(e.preventDefault(),e.stopPropagation());let t=document.querySelector("#liveDialog");null!=t&&(t.close(),t.style.display="none")},chunk:(t,i)=>{i??=10;let o=[];for(let e=0;t.length>e;e+=i)o.push(t.slice(e,e+i));return o},hash:(e,t)=>{t??="SHA-1";const o=(new TextEncoder).encode(e);return new Promise(i=>{crypto.subtle.digest(t,o).then(e=>{const t=Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0"));i(t.join(""))})})},cookie:(t,i)=>{if(null==i)document.cookie=t+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT";else{let e=new Date;e.setMonth(9+e.getMonth()),document.cookie=`${t}=${i}; path=/; domain=".bilibili.com"; expires=${e.toUTCString()}`}},load:(e,t)=>(t??=null,GM_getValue(`${e}_${u.host()}`,t)),save:(e,t)=>{t??=null,GM_setValue(`${e}_${u.host()}`,t)},strcut:(e,t,i)=>{i??="";let o,a,n;return o=-1==(n=e.lastIndexOf(t))?0:n+t.length,a=i.length&&-1!=(n=e.indexOf(i,o))?n:e.length,e.slice(o,a)},download:(e,t,i)=>{i??=null;let o={url:e,name:t??=null,conflictAction:"prompt",headers:{referer:location.href,"User-Agent":navigator.userAgent}};GM_download(Object.assign(o,i))},form:(e,o)=>{let t=document.querySelectorAll(`${e} [name]`);t.length&&t.forEach(t=>{let i=t.getAttribute("name");if(Object.hasOwn(o,i)){let e=o[i];switch(t.getAttribute("type")){case"checkbox":t.checked=1==e;break;case"radio":t.checked=e==t.value;break;default:t.value=e.toString()}}})},input:(e,t)=>{e.value=t,e.dispatchEvent(new Event("input",{bubbles:true}))},date:(e,t)=>{t??="m-d H:M";let i,o=Number.isInteger(e)?e:0;switch(o.toString().length){case 10:i=new Date(1e3*e);break;case 13:i=new Date(e);break;default:i=new Date}const a={y:i.getFullYear(),m:1+i.getMonth(),d:i.getDate(),H:i.getHours(),M:i.getMinutes(),S:i.getSeconds()};for(const n in a)a[n]=a[n].toString().padStart(2,"0");return t.replaceAll(/[HMSdmy]/g,e=>Object.hasOwn(a,e)?a[e]:e)},rc4:(i,o)=>{let a=[];const n=[...Array(256).keys()],r=i.length;for(let e=0,t=0;t<256;t++)e=(e+n[t]+i.charCodeAt(t%r))%256,[n[t],n[e]]=[n[e],n[t]];for(let e=0,t=0,i=0;i<o.length;i++){t=(t+1)%256,e=(e+n[t])%256,[n[t],n[e]]=[n[e],n[t]];const l=o.charCodeAt(i)^n[(n[t]+n[e])%256];a.push(String.fromCharCode(l))}return a.join("")}},box={home:"http://220.205.16.51:20291",version:GM_info.script.version,homepage:GM_info.script.homepage,aria2:{jsonrpc:"http://localhost:6800/jsonrpc"},now:u.now(),wait:0,init:0},motrix=async()=>{let e={id:u.uid(),method:"aria2.changeGlobalOption",params:[]};return box.aria2?.token&&e.params.push("token:"+box.aria2.token),e.params.push({"max-concurrent-downloads":"1"}),"OK"==(await u.ajax({timeout:1e3,url:box.aria2.jsonrpc,data:JSON.stringify(e)}))?.result||(u.dialog("1. \u68c0\u67e5Motrix\u662f\u5426\u5df2\u7ecf\u8fd0\u884c<br>2. \u53f3\u952e\u70b9\u51fb\u4e0b\u8f7d\u6309\u94ae\u67e5\u770b\u8bbe\u7f6e\u662f\u5426\u6b63\u786e<br>3. \u68c0\u67e5Motrix\u7684\u8bbe\u7f6e\u6216\u5bf9\u5176\u91cd\u7f6e"),false)};if(GM_addStyle('@import url("https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css");@keyframes spin{to{transform:rotate(1turn)}}.spinner{display:inline-block;animation-name:spin;animation-duration:1.8s;animation-timing-function:linear;animation-iteration-count:infinite}i[class^=bi-]{display:inline-block;margin-right:.25em}#liveDialog{font-size:16px;line-height:1.5;min-width:320px;max-width:720px;margin:auto;padding:1.5em;cursor:default;text-align:justify;border:none;outline:none;--radius:.5rem;--dark:rgb(0 0 0/0.5);--shadow:rgb(0 0 0/0.1);--light:rgb(255 255 255/0.1);--bright:rgb(255 255 255/0.9);--color-sky-600:oklch(58.8% 0.158 241.966);& *{box-sizing:border-box}& button{font-size:16px;line-height:2.6;display:inline-block;padding:0 2em;cursor:default;transition-duration:.6s;transition-property:background-color,color;white-space:nowrap;border:1px solid var(--shadow);border-radius:var(--radius);background-color:var(--color-sky-600);&:hover{background-color:hsl(from var(--color-sky-600) h s calc(1.2 * l))}}& div.group{display:inline-flex;border:none;border-radius:var(--radius);background-color:var(--color-sky-600);&>button{flex:1;border:none;border-radius:0;color:rgb(255 255 255/.8);&:first-child{border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}&:last-child{border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}&:hover{color:#fff;background-color:rgb(0 0 0/.2)}}&.full{display:flex}}& form{width:100%;margin:0!important;&>div{font-size:.875em;margin-bottom:1em;color:var(--dark)}&>button{display:block;width:100%;margin:1.25rem 0;border:none;border-radius:var(--radius)}&>label{display:block;margin-bottom:1rem;&>input{border-radius:var(--radius);font-size:inherit}&>span{display:flex;align-items:center;border:1px solid var(--shadow);border-radius:var(--radius);background-color:var(--light);&>:first-child{border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}&>:last-child{border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}&>button{font-size:.875rem;line-height:2.75;flex:none;min-width:4rem;text-align:center;border:none;background-color:unset}&>input{flex:auto;border:none;outline:none;background-color:unset}&>i,&>svg{flex:none;width:1rem;height:1rem;margin-right:.75rem!important;margin-left:.75rem;&:is(i):before{vertical-align:text-top!important}}&>i+input,&>svg+input{padding-left:0}&:has(>input:focus){border-color:var(--color-sky-600)}}}}& input,select{line-height:2;display:block;width:100%;padding:.25rem .75rem;border:1px solid var(--shadow);background-color:var(--bright);margin-top:.25rem;&:autofill{-webkit-text-fill-color:var(--dark);-webkit-background-clip:text;background-clip:text}}& select{border-radius:var(--radius);appearance:none}& input:is([type=checkbox],[type=radio]){display:inline-block;width:1em;height:1em;margin-top:0;margin-right:.25em;padding:0;vertical-align:text-bottom}& input:focus{border-color:var(--color-sky-600);outline:none}& input::placeholder{font-size:.875em;color:var(--dark)}}'),"pan.baidu.com"==location.hostname){const Ra=e=>{e instanceof MouseEvent&&(e.preventDefault(),e.stopPropagation());const t=document.createElement("form");t.method="dialog",t.insertAdjacentHTML("beforeend",'<label>Motrix jsonrpc <input name="jsonrpc" type="text" autocomplete="off" placeholder="http://localhost:16800/jsonrpc" required></label><label>Motrix Secret Key <input name="token" type="text" autocomplete="off" placeholder="\u6ca1\u6709\u79d8\u94a5\u5219\u4e0d\u8981\u586b\u5199"></label><div class="group"><button type="button"><i class="bi-x-square"></i>\u53d6\u6d88</button><button type="submit"><i class="bi-check2-square"></i>\u786e\u5b9a</button></div><div style="user-select:none"><span id="visit" style="color:#7f22fe;cursor:default;margin-right:3em">\u7b7e\u5230</span> \u5f53\u524d\u79ef\u5206<span id="integral" style="margin-left:.5em">0</span></div>'),t.addEventListener("submit",e=>{e.preventDefault(),e.stopPropagation();const t=new FormData(e.target);box.aria2=Object.assign({},box.defaults,Object.fromEntries(t)),u.save("aria2",box.aria2),u.xdialog()}),t.querySelector("button[type=button]").addEventListener("click",u.xdialog),t.querySelector("#visit").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),u.ajax({url:`${box.home}/api/baiduvisit`,data:JSON.stringify({ui:box.ui})}).then(e=>{0==e?.code&&(t.querySelector("#integral").textContent=e.num)})}),u.dialog(t),u.form("#liveDialog",box.aria2),u.ajax({url:`${box.home}/api/baidupi`,data:JSON.stringify({ui:box.ui})}).then(e=>{0==e?.code&&(t.querySelector("#integral").textContent=e.num)})},Sa=async()=>{if(box.wait)u.dialog("\u8bf7\u7a0d\u540e\u518d\u64cd\u4f5c");else if(null==box.si)u.dialog("\u8fde\u63a5\u89e3\u6790\u670d\u52a1\u5668\u5931\u8d25");else if(await motrix()){let t=[];for(const e of box.dcontext.instanceForSystem.list.getSelected())e.isdir?t=t.concat(await(async e=>{const t=await fetch(`/rest/2.0/xpan/multimedia?method=listall&recursion=1&path=${encodeURIComponent(e)}`).then(e=>e.json());return 0==t?.errno?t.list.filter(e=>!e.isdir):[]})(e.path)):t.push(e);if(0<t.length){box.wait=1;const o=document.querySelector("#dlink>i");o.className="bi-arrow-clockwise spinner";let e={sign:box.ui.sign,timestamp:box.ui.timestamp,fidlist:JSON.stringify(t.map(e=>e.fs_id)),type:"dlink",vip:"0",channel:"chunlei",web:"1",app_id:"250528",bdstoken:box.ui.token,logid:box.ui.logid,jsToken:unsafeWindow.jsToken,clienttype:"0","dp-logid":unsafeWindow.bpDataInit.getDpLogId()},i=await fetch(`/api/download?${u.serialize(e)}`).then(e=>e.json()).catch(e=>e.message);if(0==i?.errno)if(t=t.map(t=>{const e=i.dlink.find(e=>e.fs_id==t.fs_id);return t.dlink=null==e?"":e.dlink,{fid:t.fs_id,out:t.path,size:t.size,dlink:t.dlink}}).filter(e=>0<e.dlink.length),0==(i=await u.ajax({url:`${box.home}/api/baidupi`,data:JSON.stringify({ui:box.ui})}))?.code){const a=i?.homepage||box.homepage;if(i.version==box.version){let e=t.reduce((e,t)=>e+Math.ceil(t.size/(1<<30)),0);if(i.num<e)u.dialog("\u89e3\u6790\u70b9\u6570\u4e0d\u8db3");else if(2==box.ui.vip)for(const n of t)await u.ajax({url:`${box.home}/api/dlink1`,data:JSON.stringify({ui:box.ui,si:box.si,fi:n})}).then(e=>{0==e?.code&&u.aria2(e.data)});else{let e=t.filter(e=>!e.out.startsWith(box.si.sdir)||300<<20>=e.size);if(0<e.length)for(const r of t)await u.ajax({url:`${box.home}/api/dlink1`,data:JSON.stringify({ui:box.ui,si:box.si,fi:r})}).then(e=>{0==e?.code&&u.aria2(e.data)});if(0<(e=t.filter(e=>e.out.startsWith(box.si.sdir)&&300<<20<e.size)).length)if(0===(i=await u.ajax({url:`${box.home}/api/dlink2`,data:JSON.stringify({ui:box.ui,si:box.si,list:e})}))?.code)for(const l of i.data)await u.ajax({url:`${box.home}/api/dlink1`,data:JSON.stringify({ui:box.ui,si:box.si,fi:l})}).then(e=>{0==e?.code&&u.aria2(e.data)});else u.dialog(i.message)}}else u.dialog(`请先更新脚本<br><a href="${a}" target="_blank">${a}</a>`)}else u.dialog("\u8fde\u63a5\u89e3\u6790\u670d\u52a1\u5668\u5931\u8d25");else u.dialog("\u8bfb\u53d6\u4e0b\u8f7d\u6587\u4ef6\u4fe1\u606f\u5931\u8d25<br>\u8bf7\u7a0d\u540e\u5237\u65b0\u9875\u9762\u91cd\u8bd5");o.className="bi-rocket",box.wait=0}else u.dialog("\u672a\u52fe\u9009\u6587\u4ef6\u8d44\u6e90")}};box.opt={token:"",jsonrpc:"http://localhost:16800/jsonrpc"},box.aria2=u.load("aria2",box.opt),location.pathname.startsWith("/s/")&&GM_addStyle(".bd-aside-ad,.module-share-footer{display: none !important}"),"/share/init"==location.pathname&&GM_addStyle("#init-new{background: none !important}#ft,iframe{display: none !important}"),"/login"==location.pathname&&localStorage.clear(),"/disk/home"==location.pathname&&location.search.includes("stayAtHome")&&(GM_addStyle('#layoutMain{font-size:14px}div.file-name{font-family:"Microsoft YaHei UI", monospace}.wp-side-options,span.newIcon,span[node-type=find-apps],[node-type=header-union],dd.desc-box>div,img.btn-img-tips,span.user-name,[node-type=header-apps],dd:has(> .dir-card-small, > .dir-share-small, > .dir-apps-small){display:none !important}'),unsafeWindow.XMLHttpRequest=new Proxy(XMLHttpRequest,{construct:e=>{let n,r;return new Proxy(new e,{set:(e,t,i)=>Reflect.set(e,t,i),get:(e,t)=>{let i=e[t];if("function"==typeof i&&(i=function(){return"open"==t&&(n=arguments[1]),"send"==t&&(r=arguments[0]),Reflect.apply(e[t],e,arguments)}),"responseText"==t){if(n.includes("/adx")){const o=JSON.parse(i);o.hasOwnProperty("list")&&(o.list=null,o.error_code=31402,i=JSON.stringify(o))}if(n.includes("/api/quota")){const a=new URLSearchParams(u.strcut(n,"?"));box.init||(box.init=1,fetch("/rest/2.0/membership/user/info?method=query&clienttype=0&app_id=250528&web=1").then(e=>e.json()).catch(e=>e.message).then(i=>{if(1==i?.user_info?.loginstate){let e=document.querySelector(".blue-upload").closest("div");e&&(e.insertAdjacentHTML("afterbegin",'<button id="dlink" style="border:none;background-color:#7f22fe;color:#fff;height:34px;line-height:34px;padding:0 18px;margin-right:5px;border-radius:4px;font-size:14px;"><i class="bi-rocket"></i>\u4e0b\u8f7d</button>'),(e=document.querySelector("#dlink")).addEventListener("click",Sa),e.addEventListener("contextmenu",Ra)),GM.cookie.list().then(e=>{const t=u.fixcookie(e);t.includes("BDUSS")?(box.ui={cookie:t,uid:i.user_info.uk.toString(),vip:i.user_info.is_svip?2:0,logid:a.get("logid"),token:a.get("bdstoken")},box.dcontext=unsafeWindow.require("system-core:context/context.js"),(async()=>{let e={fields:'["sign1","sign2","sign3","timestamp"]',channel:"chunlei",web:"1",app_id:"250528",bdstoken:box.ui.token,logid:box.ui.logid,clienttype:"0","dp-logid":unsafeWindow.bpDataInit.getDpLogId()},o=(fetch(`/api/gettemplatevariable?${u.serialize(e)}`).then(e=>e.json()).catch(e=>e.message).then(e=>{0==e?.errno&&(box.ui.timestamp=e.result.timestamp,box.ui.sign=btoa(u.rc4(e.result.sign3,e.result.sign1)))}),0),t=await u.ajax({url:`${box.home}/api/baidusi`,data:JSON.stringify({ui:box.ui})});if(1!=t?.code&&(0==t?.code&&(box.si=t.data,await fetch(`https://pan.baidu.com/share/init?surl=${box.si.surl}`,{method:"HEAD"}).then(e=>{200==e.status&&(o=1,box.si.skey=decodeURIComponent(u.strcut(document.cookie,"BDCLND=",";")))})),!o)){box.si={};let e,t,i;box.si.sdir=`/${Number.parseInt(box.ui.uid).toString(16).toUpperCase()}`,i={target:JSON.stringify([box.si.sdir]),channel:"chunlei",web:"1",app_id:"250528",bdstoken:box.ui.token,logid:box.ui.logid,clienttype:"0","dp-logid":unsafeWindow.bpDataInit.getDpLogId()},0==(e=await fetch(`/api/filemetas?${u.serialize(i)}`).then(e=>e.json()))?.errno&&(o=1,box.si.fid=e.info[0].fs_id.toString()),o||(t={path:box.si.sdir,isdir:"1",rtype:"0",block_list:"[]"},i={a:"commit",channel:"chunlei",web:"1",app_id:"250528",bdstoken:box.ui.token,logid:box.ui.logid,clienttype:"0","dp-logid":unsafeWindow.bpDataInit.getDpLogId()},(e=await fetch(`/api/create?${u.serialize(i)}`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:u.serialize(t)}).then(e=>e.json()))?.path&&(o=1,box.si.fid=e.fs_id.toString(),box.si.sdir=e.path)),o&&(box.si.pwd=u.pwd(),t={channel_list:"[]",period:"0",pwd:box.si.pwd,schannel:"4",fid_list:JSON.stringify([box.si.fid])},i={channel:"chunlei",web:1,app_id:"250528",bdstoken:box.bdstoken,logid:box.ui.logid,clienttype:0,"dp-logid":unsafeWindow.bpDataInit.getDpLogId()},0==(e=await fetch(`/share/set?${u.serialize(i)}`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:u.serialize(t)}).then(e=>e.json()))?.errno?(box.si.share=e.shareid.toString(),box.si.surl=u.strcut(e.link,"/s/","?").slice(1)):o=0),o&&await fetch(`https://pan.baidu.com/share/init?surl=${box.si.surl}`,{method:"HEAD"}).then(e=>{200==e.status?box.si.skey=decodeURIComponent(u.strcut(document.cookie,"BDCLND=",";")):(o=0,box.si=null)}),o&&await u.ajax({url:`${box.home}/api/baidusi`,data:JSON.stringify({ui:box.ui,si:box.si})})}})()):u.dialog("1. \u811a\u672c\u7ba1\u7406\u5668\u9700\u8981\u4f7f\u7528\u7ea2\u7334<br>2. \u5c1d\u8bd5\u6362Firefox\u6d4f\u89c8\u5668\u4f7f\u7528")})}}))}}return i}})}}))}if(location.hostname.includes("123pan")){GM_addStyle(".ant-table-body{overflow-x: hidden}.anticon-exclamation-circle,.space-icon,.special-menu-item-container,.sider-member-btn,.mfy-main-layout>[class^=mfy-main-layout],ul.ant-menu>li[data-menu-id$=recycle]~li,div.sysbut.sysRadio:nth-of-type(6),div.file-operator-group-button:nth-child(6)~div{display: none !important}");const hb=()=>{if(!box.wait&&"/"==location.pathname){box.wait=1,setTimeout(()=>{box.wait=0},1e3);let i=document.querySelector("#dlink");if(!location.search.includes("category")&&null==i){let e=0,t=setInterval(()=>{null==(i=document.querySelector(".home-operator-button-group"))?e++<9||clearInterval(t):(clearInterval(t),i.insertAdjacentHTML("afterbegin",'<button id="dlink" style="font-size:.875rem;background-color:#3c80ff;border-radius:.5em;margin-right:.5em;padding:0 1.25em;line-height:2.815em;color:#fff;white-space:nowrap"><i class="bi-rocket" style="font-size: 1rem"></i>\u4e0b\u8f7d</button>'),(i=document.querySelector("#dlink")).addEventListener("click",jb),i.addEventListener("contextmenu",ib))},1e3)}}},ib=e=>{e instanceof MouseEvent&&(e.preventDefault(),e.stopPropagation());const t=document.createElement("form");t.method="dialog",t.insertAdjacentHTML("beforeend",'<label>Motrix jsonrpc <input name="jsonrpc" type="text" autocomplete="off" placeholder="http://localhost:16800/jsonrpc" required></label><label>Motrix Secret Key <input name="token" type="text" autocomplete="off" placeholder="\u6ca1\u6709\u79d8\u94a5\u5219\u4e0d\u8981\u586b\u5199"></label><div class="group full"><button type="button"><i class="bi-x-square"></i>\u53d6\u6d88</button><button type="submit"><i class="bi-check2-square"></i>\u786e\u5b9a</button></div>'),t.addEventListener("submit",e=>{e.preventDefault(),e.stopPropagation();const t=new FormData(e.target);box.aria2=Object.assign({},box.opt,Object.fromEntries(t.entries())),u.save("aria2",box.aria2),u.xdialog()}),t.querySelector("button[type=button]").addEventListener("click",u.xdialog),u.dialog(t),u.form("#liveDialog",box.aria2)},jb=async e=>{if(e.preventDefault(),e.stopPropagation(),box.wait)u.dialog("\u8bf7\u7a0d\u540e\u518d\u64cd\u4f5c");else if(await motrix()){let e,t,i,o=[],a=u.usp(location.search)??{homeFilePath:""};if((i=a.homeFilePath.split(",").map(e=>({fileId:e}))).length&&(e=await fetch("/b/api/file/info",{method:"POST",headers:box.ui.hat,body:JSON.stringify({fileIdList:i})}).then(e=>e.json()).catch(e=>e.message),i=Array.isArray(e?.data?.infoList)?e.data.infoList.map(e=>({fid:e.FileId,pid:e.ParentFileId,name:decodeURIComponent(e.FileName)})):[]),document.querySelectorAll("div.ant-table-row-selected").forEach(e=>{o.push(e.getAttribute("data-row-key"))}),o.length){const n=document.querySelector("#dlink>i");if(n.className="bi-arrow-clockwise spinner",box.wait=1,t={version:box.version,ui:box.ui,data:{dirs:i,files:o}},0==(e=await u.ajax({url:`${box.home}/api/dlink123`,data:JSON.stringify(t)}))?.code){const r=Object.assign({},box.ui.hat,{platform:"android","App-Version":"3","User-Agent":"123pan/v2.5.1(Android_11;Xiaomi)"});for(const l of e.data)fetch(`https://www.123pan.com/api/file/download?file_id=${l.fid}`,{method:"GET",headers:r}).then(e=>e.json()).catch(e=>e.message).then(e=>{e?.data?.url&&u.aria2({url:[e.data.url],info:{out:l.out}})})}else e?.message&&u.dialog(e.message);box.wait=0,n.className="bi-rocket"}else u.dialog("\u672a\u52fe\u9009\u6587\u4ef6\u8d44\u6e90")}};box.opt={jsonrpc:"http://localhost:16800/jsonrpc",token:""},box.aria2=u.load("aria2",box.opt),box.ui={uid:localStorage.getItem("areaid"),hat:{Authorization:`Bearer ${localStorage.getItem("authorToken")}`,LoginUuid:localStorage.getItem("LoginUuid"),"User-Agent":navigator.userAgent}},window.addEventListener("urlchange",hb)}if(location.hostname.includes("qq.com")){GM_addStyle(".txp-layer.txp-layer-dynamic-above-control,.playlist-overlay-minipay,.client_download,.nav-policy-wrap,.txp-layer:has(.txp-little-tip),.mod_quick>div:not(:last-child),.icon_vip_pic,.adv_report,.playlist-video-modules-union,.txp-little-tip,.video-card-wrap[element-id]{display: none !important}"),unsafeWindow.console=new Proxy(console,{get:(e,t)=>"clear"===t?function(){}:e[t]});const Ib=document.cookie.includes("guid=")?u.strcut(document.cookie,"guid=",";"):null;if(null==Ib)localStorage.clear();else{unsafeWindow.XMLHttpRequest=new Proxy(XMLHttpRequest,{construct:e=>{let o,a;return new Proxy(new e,{set:(e,t,i)=>Reflect.set(e,t,i),get:(e,t)=>{let i=e[t];if("function"==typeof i&&(i=function(){if("open"==t&&(o=arguments[1]),"send"==t&&(a=arguments[0],o.includes("/proxyhttp"))){let e=JSON.parse(a);"vinfoad"==e.buid&&(e.buid="onlyvinfo",a=JSON.stringify(e),arguments[0]=a)}return Reflect.apply(e[t],e,arguments)}),"response"==t&&o.endsWith("/proxyhttp")&&(a.includes("onlyad")&&(i='{"errCode":1}'),a.includes("onlyvinfo"))){let e=u.load("vi"),t=JSON.parse(a),o=new URLSearchParams(t.vinfoparam).get("vid");if(o==e?.vid)i=e.doc;else{let e,t=JSON.parse(i);e=JSON.parse(t.vinfo),Object.hasOwn(e,"dltype")&&(e.preview=Number.parseInt(e.vl.vi[0].td),e.vl.vi[0].ad=null,e.vl.vi[0].wl=null,e.fl.cnt=1,t.vinfo=JSON.stringify(e),i=JSON.stringify(t)),u.ajax({url:`${box.home}/api/vtxlink`,data:a}).then(i=>{if(Object.hasOwn(i,"vinfo")){let t=JSON.parse(i.vinfo);if(Object.hasOwn(t,"dltype")){let e=Number.parseInt(t.vl.vi[0].td);e>t.preview&&(t.preview=e),t.vl.vi[0].ad=null,t.vl.vi[0].wl=null,t.fl.cnt=1,i.vinfo=JSON.stringify(t)}u.save("vi",{vid:o,doc:JSON.stringify(i)}),setTimeout(()=>{let t=0,i=setInterval(()=>{const e=document.querySelector("div[data-payload] span[data-dt='fhd']");null==e?t++<9||clearInterval(i):(clearInterval(i),e.click())},1e3)},5e3)}else if(9==i?.code){const e=u.now(),t=u.load("tipLatest",0);t<e&&(u.save("tipLatest",e+900),u.dialog("\u4eca\u65e5\u89e3\u6790\u6b21\u6570\u5df2\u7528\u5b8c \u660e\u5929\u518d\u6765\u5427"))}})}}return i}})}}),box.ui=u.load("ui");const Lb=u.load("latest");box.now<=Lb&&Ib==box.ui?.uid||(u.save("latest",box.now+900),GM_cookie.list({},e=>{let t=u.fixcookie(e);box.ui={uid:Ib,cookie:t},u.save("ui",box.ui),u.ajax({url:`${box.home}/api/vtxsta`,data:JSON.stringify({ui:box.ui,version:box.version})}).then(e=>{9==e?.code&&GM_openInTab(e.message)})}))}}if(location.hostname.includes("bilibili.com")){GM_addStyle(".video-card-ad-small,.space-notice,.video-ai-assistant-bg::after,.video-ai-assistant-bg::before,#notice,#slide_ad,#tool-bar-more,.btn-ad,.img-ad,.b-footer-wrap>.split-line,.other-link,.footer-icons,.recommended-swipe,.act-end,.act-now,.ad-report,.adblock-tips,.adcard,.bpx-player-error-sign,.bpx-player-toast-wrap,.container>.bili-video-card:not(.enable-no-interest),.container>.feed-card,.container>.floor-single-card,.container>.grid-anchor,.download-entry,.download-entry,.eva-banner,.feed-roll-btn,.flexible-roll-btn-inner>.btn-text,.international-footer,.left-entry>.v-popover-wrap:not(:has(>a)),.login-protocol,.storage-box,.video-ai-assistant-badge,.video-page-game-card-small,.video-tool-more,.vip-entry-containter,.vip-wrap,[class^=areaLimitPop_content],[class^=bili-live-card],[class^=paybar_container],div.bili-feed-card:has(>div[class^=bili-live-card]){display: none !important}");const k1={vtag:l=>new Promise((e,t)=>{let o=0,a=l.length,n=[];const r=async()=>{let t=l[o++],i=await fetch(`https://api.bilibili.com/x/web-interface/view/detail/tag?bvid=${t}`,{method:"GET",mode:"cors",credentials:"same-origin"}).then(e=>e.json()).catch(e=>e.message);if(0==i?.code){let e=i.data.map(e=>e.tag_name).join(" ").toLowerCase();u.inone(e,box.words)&&n.push(t)}else n.push(t);a>o?r():e(n)};for(let e=0;Math.min(5,a)>e;e++)r()})},l1=()=>{localStorage.clear(),GM_cookie.list({},async e=>{for(const t of e)await GM_cookie.delete({name:t.name});location.replace("https://passport.bilibili.com/login")})};if("www.bilibili.com"==location.hostname){const C1=e=>{e instanceof MouseEvent&&(e.preventDefault(),e.stopPropagation());let t=document.createElement("form");t.method="dialog",t.insertAdjacentHTML("beforeend",'<label><input name="vhd" type="checkbox" value="1">\u542f\u7528\u9ad8\u753b\u8d28\u64ad\u653e\u89c6\u9891</label><label><input name="coin" type="checkbox" value="1">\u5141\u8bb8\u811a\u672c\u70b9\u8d5e/\u6536\u85cf/\u6295\u5e01</label><label><input name="subtitle" type="checkbox">\u6062\u590d\u89c6\u9891AI\u5b57\u5e55</label><div class="summary">\u4e0d\u80fd\u6b63\u5e38\u663e\u793aAI\u5b57\u5e55\u624d\u9700\u8981\u52fe\u9009\u300c\u4fee\u590d\u5b57\u5e55\u300d</div><label>\u52a0\u901f\u8282\u70b9 <select name="cdn"><option value="off">\u5173\u95ed</option><option value="akamaiupos-hz-mirrorakam.akamaized.net">\u963f\u5361\u8fc8</option><option value="upos-sz-mirrorali.bilivideo.com">\u963f\u91cc</option><option value="upos-sz-mirrorcos.bilivideo.com">\u817e\u8baf</option><option value="upos-sz-mirrorhw.bilivideo.com">\u534e\u4e3a</option><option value="upos-sz-mirrorkodo.bilivideo.com">\u4e03\u725b</option></select></label><div class="summary">\u89c6\u9891\u64ad\u653e\u7ecf\u5e38\u5361\u987f\u624d\u9700\u8bbe\u7f6e\u9002\u5408\u81ea\u5df1\u7684\u8282\u70b9</div><label>\u8fc7\u6ee4\u9996\u9875\u63a8\u8350\u89c6\u9891 <input name="words" type="text" placeholder="\u586b\u5199\u5173\u952e\u8bcd\u4ee5\u7a7a\u683c\u5206\u9694"></label><div class="summary">\u89c6\u9891\u6807\u7b7e\u542b\u6709\u8bbe\u7f6e\u7684\u4efb\u610f\u5173\u952e\u8bcd\u90fd\u4f1a\u88ab\u5c4f\u853d</div><div class="group"><button type="button"><i class="bi-x-square"></i>\u53d6\u6d88</button><button type="submit"><i class="bi-check2-square"></i>\u786e\u5b9a</button></div>'),u.dialog(t),t.addEventListener("submit",e=>{e.preventDefault(),e.stopPropagation();let t=JSON.parse(localStorage.getItem("bpx_player_profile")),i=(Object.assign(t.media,{autoplay:false,dolbyAudio:true,listLoop:false,opEd:true,quality:120}),localStorage.setItem("bpx_player_profile",JSON.stringify(t)),localStorage.setItem("recommend_auto_play","close"),localStorage.setItem("b_miniplayer","0"),new FormData(e.currentTarget));if(i.set("vhd",i.has("vhd")?1:0),i.set("coin",i.has("coin")?1:0),i.set("subtitle",i.has("subtitle")?1:0),i.has("words")){let e=i.get("words").split(" ").filter((e,t,i)=>i.indexOf(e)==t);i.set("words",e.sort().reverse().join(" "))}box.aria2=Object.assign({},box.opt,Object.fromEntries(i)),u.save("aria2",box.aria2),u.ajax({url:`${box.home}/api/bzcoin`,data:JSON.stringify({ui:box.ui,coin:i.get("coin")})}).then(e=>{0==e?.code?fetch("//api.bilibili.com/x/v2/history/shadow/set",{method:"POST",mode:"cors",credentials:"include",body:u.serialize({switch:"true",csrf:u.strcut(document.cookie,"bili_jct=",";")}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}):D1()}).finally(u.xdialog)}),t.querySelector("button[type=button]").addEventListener("click",u.xdialog),u.ajax({url:`${box.home}/api/bzusta`,data:JSON.stringify({ui:box.ui})}).then(e=>{switch(e?.code){case 0:box.aria2.coin=e.coin,u.form("#liveDialog",box.aria2);const i=t.querySelectorAll("input[type=checkbox]");i.forEach((e,t)=>{switch(t){case 0:e.addEventListener("change",e=>{i[0].checked&&(i[1].checked=true)});break;case 1:e.addEventListener("change",e=>{i[1].checked||(i[0].checked=false)})}});break;case 1:u.dialog("\u8fde\u63a5\u89e3\u6790\u670d\u52a1\u5668\u5931\u8d25");break;default:u.save("latest",0),u.dialog(e?.message)}})},D1=()=>{u.save("latest",box.now+9e3),fetch("//api.bilibili.com/x/web-interface/nav",{method:"GET",mode:"cors",credentials:"include"}).then(e=>e.json()).catch(e=>e.message).then(i=>{i?.data?.isLogin?GM_cookie.list({},e=>{let t=u.fixcookie(e);t.includes("SESSDATA")?(box.ui={mid:i.data.mid.toString(),vip:i.data.vipStatus,cookie:t},u.save("ui",box.ui),u.ajax({url:`${box.home}/api/bzusta`,data:JSON.stringify({ui:box.ui})}).then(e=>{switch(e?.code){case 0:0==e.coin&&(box.aria2.vhd=0,u.save("aria2",box.aria2)),box.version!=e?.version&&(u.save("latest",0),location.replace(e.homepage??GM_info.script.homepage));break;case 1:u.dialog("\u8fde\u63a5\u89e3\u6790\u670d\u52a1\u5668\u5931\u8d25");break;default:u.dialog(e?.message)}})):box.aria2.vhd&&u.dialog("\u4e0d\u80fd\u5f00\u542f\u5927\u4f1a\u5458\u529f\u80fd \u8bf7\u68c0\u67e5\u4ee5\u4e0b\u95ee\u9898<br>1. \u9700\u8981\u642d\u914dTampermonkey Beta\u7248\u300c\u7ea2\u7334\u300d\u4f7f\u7528<br>2. \u81ea\u884c\u6392\u67e5\u5b58\u5728\u51b2\u7a81\u7684\u811a\u672c<br>3. \u5c1d\u8bd5\u6362Firefox\u6d4f\u89c8\u5668\u4f7f\u7528")}):l1()})},E1=()=>{if(player.isInitialized()){let e=player.getQuality();Math.max.apply(null,player.getSupportedQualityList())>e.nowQ?(player.setVipQuality(),setTimeout(E1,1e3)):player.isPaused()&&player.play()}else setTimeout(E1,1e3)};if(box.vi={id:0,doc:""},box.opt={cdn:"off",vhd:1,coin:1,subtitle:0,words:""},box.aria2=u.load("aria2",box.opt),box.ui=u.load("ui"),box.mid=document.cookie.includes("DedeUserID")?u.strcut(document.cookie,"DedeUserID=",";"):null,null==box.mid)l1();else{if(box.mid==box.ui?.mid){let e=u.load("latest",0);box.now>e&&D1()}else D1();if(box.mid&&box.aria2.vhd){if(unsafeWindow.fetch=new Proxy(fetch,{apply:(e,t,i)=>Reflect.apply(e,t,i).then(async t=>{const e=i[0]instanceof Request?i[0].url:i[0];if(e.includes("/nav/stat")){let i=document.querySelector(".logout-item");i&&i.hasAttribute("name")||setTimeout(()=>{if((i=u.dcopy(i)).setAttribute("name","init"),i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),GM_cookie.list({},e=>{let t=u.load("account",{});t[box.mid]=e.map(e=>({domain:e.domain,expirationDate:e.expirationDate,httpOnly:e.httpOnly,name:e.name,path:e.path,secure:e.secure,value:e.value})),u.save("account",t),l1()})}),null==document.querySelector("ul[name=account]")){let e="",a=u.load("account",{});for(const t in a)t!=box.mid&&(e+=`<li name="${t}"><svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg" class="link-icon"><rect opacity="0.01" width="18" height="18" fill="white"></rect><path d="M12.1146 9.48983C13.2763 8.63331 14.0299 7.2548 14.0299 5.7035C14.0299 3.11005 11.9198 1 9.32636 1C6.73291 1 4.62286 3.11005 4.62286 5.7035C4.62286 7.2548 5.37829 8.63331 6.53808 9.48983C3.87662 10.589 2 13.2118 2 16.2648C2 16.671 2.32901 17 2.73521 17C3.14141 17 3.47042 16.671 3.47042 16.2648C3.47042 13.0335 6.09879 10.407 9.3282 10.407C12.5576 10.407 15.186 13.0354 15.186 16.2648C15.186 16.671 15.515 17 15.9212 17C16.3274 17 16.6564 16.671 16.6564 16.2648C16.6546 13.2118 14.7761 10.589 12.1146 9.48983ZM6.09144 5.7035C6.09144 3.91878 7.54348 2.46858 9.32636 2.46858C11.1092 2.46858 12.5613 3.92062 12.5613 5.7035C12.5613 7.48639 11.1092 8.93843 9.32636 8.93843C7.54348 8.93843 6.09144 7.48639 6.09144 5.7035Z" fill="var(--text2)"></path></svg> &nbsp; <span style="vertical-align: 4px">${t}</span></li>`);i.insertAdjacentHTML("afterend",`<ul name="account" style="cursor:default;margin:1rem 0 0 1rem;line-height:2.5rem">${e}</ul>`),document.querySelector("ul[name=account]").addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),GM_cookie.list({},async e=>{a[box.mid]=e.map(e=>({domain:e.domain,expirationDate:e.expirationDate,httpOnly:e.httpOnly,name:e.name,path:e.path,secure:e.secure,value:e.value})),u.save("account",a);let t=a[o.target.closest("li").getAttribute("name")];if(Array.isArray(t))for(const i of t)await GM_cookie.set(i);setTimeout(()=>{location.reload()},1e3)})})}},1e3)}if(e.includes("/rcmd")){let o=await t.clone().json();if(0==o?.code&&box.aria2?.words){if(null==box.words&&(box.words="string"==typeof box.aria2.words?box.aria2.words.split(" "):[]),box.words.length){let i=Object.hasOwn(o.data,"item")?"item":Object.hasOwn(o.data,"archives")?"archives":"";if(i){let e=o.data[i].filter(e=>"av"==e.goto).filter(e=>30<e.duration),t=await k1.vtag(e.map(e=>e.bvid));o.data[i]=e.filter(e=>!t.includes(e.bvid))}}t=new Response(JSON.stringify(o))}}if(e.includes("/web-show/region/banner")){let e=await t.clone().json();0==e?.code&&(e.data=[],t=new Response(JSON.stringify(e)))}return t})}),unsafeWindow.XMLHttpRequest=new Proxy(XMLHttpRequest,{construct:e=>{let n,r;return new Proxy(new e,{set:(e,t,i)=>Reflect.set(e,t,i),get:(e,t)=>{let i=e[t];if("function"==typeof i&&(i=function(){return"open"==t&&(n=arguments[1]).includes("/login/exit/")?(l1(),e.abort()):("send"==t&&(r=arguments[0]),Reflect.apply(e[t],e,arguments))}),"responseText"==t){if(n.includes("/web-interface/nav")){let t=JSON.parse(i);if(0==t?.code){let e=JSON.parse('{"vipStatus":1,"vipType":2,"vip_label":{"path":"http://i0.hdslb.com/bfs/vip/label_annual.png","text":"\u5e74\u5ea6\u5927\u4f1a\u5458","label_theme":"annual_vip","text_color":"#FFFFFF","bg_style":1,"bg_color":"#FB7299"},"vip":{"type":2,"status":1,"nickname_color":"#FB7299","label":{"path":"http://i0.hdslb.com/bfs/vip/label_annual.png","text":"\u5e74\u5ea6\u5927\u4f1a\u5458","label_theme":"annual_vip","text_color":"#FFFFFF","bg_style":1,"bg_color":"#FB7299"}}}');Object.assign(t.data,e),i=JSON.stringify(t)}}if(n.includes("/web/season/user/status")){let e=JSON.parse(i);0==e?.code&&e?.result?.vip_info&&(e.result.vip_info.status=1,e.result.vip_info.type=1,i=JSON.stringify(e))}if(n.includes("/player/wbi/v2")){let e=JSON.parse(i);0==e?.code&&e?.data?.vip&&(e.data.vip.status=1,e.data.vip.type=1,i=JSON.stringify(e))}if(n.includes("/player/wbi/playurl")){const o=Number.parseInt(u.strcut(n,"qn=","&"));if(0==box.ui.vip&&80<o){const a=u.strcut(n,"cid=","&");let e=JSON.parse(i);if(box.vi?.id==a)e=box.vi.doc;else if(!box.wait){box.wait=1,player.isPaused()||player.pause();let e={ui:box.ui,url:u.fixurl(n.replaceAll(/dm_.+?&/g,""))};u.ajax({url:`${box.home}/api/bzview2`,data:JSON.stringify(e)}).then(t=>{switch(t?.code){case 0:t?.data?.dash&&(box.vi={id:a,doc:t},box.aria2.subtitle&&document.querySelector(".bpx-player-ctrl-subtitle")?player.reload():E1());break;case 3:u.dialog(t?.message);break;case 9:let e=u.load("douyin",0);e>box.now?player.play():(u.save("douyin",box.now+900),u.dialog("bilibili\u89e3\u6790\u6b21\u6570\u5df2\u7528\u5b8c<br>\u7b49\u6b21\u65e5\u5237\u65b0\u624d\u53ef\u7ee7\u7eed\u4f7f\u7528<br>\u6216\u53bb\u7535\u62a5\u4ea4\u6d41\u7fa4\u627e\u673a\u5668\u4eba\u5237\u65b0"));break;default:player.play()}}).finally(()=>{box.wait=0})}i=JSON.stringify(e).replaceAll('"need_login":true,',"").replaceAll('"need_vip":true,',"")}}if(n.includes("/player/web/v2/playurl")){n.includes("ep_id")?box.vid=u.strcut(n,"ep_id=","&"):n+=`&ep_id=${box.vid}`;let t=i.includes('"whole"')?JSON.parse(i):{code:1};if(box.vi.id==box.vid)t=box.vi.doc;else if(!box.wait){box.wait=1;let e={ui:box.ui,url:u.fixurl(n),iic:i.includes("AREA_LIMIT")};u.ajax({url:`${box.home}/api/bzview1`,data:JSON.stringify(e)}).then(t=>{switch(t?.code){case 0:box.vi={id:box.vid,doc:t},i.includes('"whole"')?E1():player.reload().then(()=>{box.wait=1,E1()});break;case 3:u.dialog(t?.message);break;case 9:let e=u.load("telegram",0);box.now>e&&(u.save("telegram",box.now+900),u.dialog("bilibili\u89e3\u6790\u6b21\u6570\u5df2\u7528\u5b8c<br>\u7b49\u6b21\u65e5\u5237\u65b0\u624d\u53ef\u7ee7\u7eed\u4f7f\u7528<br>\u6216\u53bb\u4ea4\u6d41\u7fa4\u5237\u65b0\u6b21\u6570"));break;default:player.reload()}}).finally(()=>{box.wait=0})}if(1==t.code)i=JSON.stringify(t);else{let e=JSON.stringify(t).replaceAll('"need_login":true,',"").replaceAll('"need_vip":true,',"");i="off"==box.aria2.cdn?e:e.replace(/\/\/.+?\//g,"//"+box.aria2.cdn+"/")}}if(n.includes("/ogv/player/playview")){let e=JSON.parse(r),t=(box.vid=e.video_index.ogv_episode_id,i.includes('"whole"')?JSON.parse(i):{code:1});if(box.vi.id==box.vid)t=box.vi.doc;else if(!box.wait){box.wait=1;let e={ui:box.ui,iic:i.includes("AreaLimitPanel"),body:r};u.ajax({url:`${box.home}/api/bzview3`,data:JSON.stringify(e)}).then(t=>{switch(t?.code){case 0:box.vi={id:box.vid,doc:t},i.includes('"whole"')?E1():player.reload().then(E1);break;case 3:u.dialog(t?.message);break;case 9:let e=u.load("telegram",0);box.now>e&&(u.save("telegram",box.now+900),u.dialog("bilibili\u89e3\u6790\u6b21\u6570\u5df2\u7528\u5b8c<br>\u7b49\u6b21\u65e5\u5237\u65b0\u624d\u53ef\u7ee7\u7eed\u4f7f\u7528<br>\u6216\u53bb\u4ea4\u6d41\u7fa4\u5237\u65b0\u6b21\u6570"));break;default:player.reload()}}).finally(()=>{box.wait=0})}if(1==t.code)i=JSON.stringify(t);else{let e=JSON.stringify(t).replaceAll('"need_login":true,',"").replaceAll('"need_vip":true,',"");i="off"==box.aria2.cdn?e:e.replace(/\/\/.+?\//g,"//"+box.aria2.cdn+"/")}}}return i}})}}),location.pathname.startsWith("/video/")){const g2=unsafeWindow?.__playinfo__;if(null==g2){setTimeout(()=>{let e=document.querySelector("div.go-home.go-whatever");e&&e.click()},1e3);const h2=u.strcut(location.pathname,"/video/","/");u.ajax({url:`${box.home}/api/bangumi?bvid=${h2}`}).then(e=>{0==e?.code&&location.replace(`https://www.bilibili.com/bangumi/play/${e?.message}`)})}else if(null==g2?.data?.dash)box.vi={id:unsafeWindow?.vd?.cid,doc:g2},setTimeout(()=>{player.isPaused()&&player.play()},1e3);else if(0==box.ui.vip){let e=Math.max.apply(null,player.getSupportedQualityList());80<e?E1():player.isPaused()&&player.play()}}if(location.pathname.startsWith("/bangumi")){let e=1,t=setInterval(()=>{null==unsafeWindow.player?e++<9||clearInterval(t):(clearInterval(t),0==box.ui.vip?player.reload():player.play())},1e3)}}if(location.pathname.startsWith("/video")){let t=0,i=setInterval(()=>{const e=document.querySelector("#arc_toolbar_report>.video-toolbar-right");null==e?t++<9||clearInterval(i):(clearInterval(i),e.insertAdjacentHTML("beforeend",'<span class="video-toolbar-right-item" id="rate" style="margin-right:1em"></span><span class="video-toolbar-right-item" id="dlink" style="margin-right:2em" title="\u53f3\u952e\u8bbe\u7f6e"><i class="bi-cloud-download" style="font-size:120%"></i>\u4e0b\u8f7d</span>'),document.querySelector("#dlink").addEventListener("contextmenu",C1),document.querySelector("#dlink").addEventListener("click",e=>{if(e.preventDefault(),e.stopPropagation(),player.isInitialized()){let o,a=player.getMediaInfo();if(o=a.playUrl.indexOf("https",5),a.playUrl&&o){document.querySelector("#dlink>i").className="bi-arrow-clockwise spinner";const n=document.querySelector("#rate");let e=a.playUrl.slice(o),t=a.playUrl.slice(0,o-1),i=u.strcut(location.pathname,"/video/","/");u.download(e,i+".mp3"),u.download(t,i+".mp4",{onload:()=>{document.querySelector("#dlink>i").className="bi-cloud-download",n.textContent=""},onprogress:e=>{n.textContent=`${(100*e.loaded/e.total).toFixed(2)}%`}})}}else u.dialog("\u8bf7\u7a0d\u540e\u518d\u8bd5\u6216\u5237\u65b0\u9875\u9762")}))},3e3);document.body.addEventListener("click",t=>{if(t.ctrlKey&&"desc-info-text"==t.target.className){let e=t.target.textContent.replaceAll(/[^\x21-\x7e]/g," ").replaceAll(/\s+/g," ").split(" ").filter(e=>e.length);e.forEach(e=>{e.startsWith("http")&&GM_openInTab(e,true)})}})}if(location.pathname.startsWith("/opus")){const C2=document.querySelector("div.bili-opus-view");C2&&C2.addEventListener("contextmenu",t=>{if(t.preventDefault(),t.stopPropagation(),"img"==t.target.tagName.toLowerCase()){let e=t.target.src.indexOf("@");-1!=e&&u.download(t.target.src.slice(0,e),`${u.uid()}.jpg`)}})}}}else unsafeWindow.XMLHttpRequest=new Proxy(XMLHttpRequest,{construct:e=>{let o,a;return new Proxy(new e,{set:(e,t,i)=>Reflect.set(e,t,i),get:(e,t)=>{let i=e[t];return"function"==typeof i?function(){return"open"==t&&(a=arguments[1]).includes("/login/exit/")?(l1(),e.abort()):("send"==t&&(o=arguments[0]),Reflect.apply(e[t],e,arguments))}:i}})}}),"space.bilibili.com"==location.hostname&&(unsafeWindow.fetch=new Proxy(fetch,{apply:(e,t,i)=>Reflect.apply(e,t,i).then(e=>{const t=i[0]instanceof Request?i[0].url:i[0];return t.includes("/acc/info?mid=11783021&")&&(GM_addStyle("section.home-section:not(:has(div.video-section)),div.section:has(#i-masterpiece){display: none !important}"),e=new Response('{"code":0,"message":"0","ttl":1,"data":{"mid":11783021,"name":"\u756a\u5267\u51fa\u5dee","sex":"\u4fdd\u5bc6","face":"http://i2.hdslb.com/bfs/face/9f10323503739e676857f06f5e4f5eb323e9f3f2.jpg","sign":"","rank":10000,"level":6,"jointime":0,"moral":0,"silence":0,"birthday":"","coins":0,"fans_badge":false,"fans_medal":{"show":false,"wear":false,"medal":null},"official":{"role":3,"title":"bilibili\u51fa\u5dee","desc":"","type":1},"vip":{"type":0,"status":0,"du6e_date":0,"vip_pay_type":0,"theme_type":0,"label":{"path":"","text":"","label_theme":"","text_color":"","bg_style":0,"bg_color":"","border_color":""},"avatar_subscript":0,"nickname_color":"","role":0,"avatar_subscript_url":""},"pendant":{"pid":0,"name":"","image":"","expire":0,"image_enhance":"","image_enhance_frame":""},"nameplate":{"nid":0,"name":"","image":"","image_small":"","level":"","condition":""},"user_honour_info":{"mid":0,"colour":null,"tags":null},"is_followed":false,"top_photo":"http://i1.hdslb.com/bfs/space/cb1c3ef50e22b6096fde67febe863494caefebad.png","theme":{},"sys_notice":{},"live_room":{"roomStatus":0}}}')),e})})),"passport.bilibili.com"==location.hostname&&(GM_addStyle("body{background-color:#fff}"),unsafeWindow.fetch=new Proxy(fetch,{apply:(e,t,i)=>Reflect.apply(e,t,i).then(e=>{const t=i[0]instanceof Request?i[0].url:i[0];if(t.includes("/x/passport-login/web/qrcode/generate")){let e=document.querySelector("#bzcard");null==e&&(e=document.querySelector(".third-party-login-wrapper>.title"))&&(e.insertAdjacentHTML("beforeend",'<span id="bzcard" style="cursor:default;margin-left:30px"><i class="bi-fire"></i>\u5361\u5bc6\u767b\u5f55</span>'),document.querySelector("#bzcard").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();let t=document.createElement("form");t.method="dialog",t.insertAdjacentHTML("beforeend",'<label class="group"><input name="sign" type="text" placeholder="\u8bf7\u8f93\u5165\u5361\u5bc6" autocomplete="off" required></label><div class="group"><button type="button"><i class="bi-x-square"></i>\u53d6\u6d88</button><button type="submit"><i class="bi-check2-square"></i>\u786e\u5b9a</button></div>'),u.dialog(t),t.addEventListener("submit",e=>{e.preventDefault(),e.stopPropagation();let t=new FormData(e.target);32==t.get("sign").length&&(t=new URLSearchParams(t).toString(),u.ajax({url:`${box.home}/api/bzcard2?${t}`}).then(e=>{if(0==e?.code){localStorage.clear();const i=u.now()+9e5,t=new Map(e.data.cookie.replaceAll(/\s+/g,"").split(";").filter(e=>5<e.length).map(e=>e.split("=")));t.forEach((e,t)=>{GM_cookie.set({name:t,value:e,domain:".bilibili.com",path:"/",expirationDate:i})}),setTimeout(()=>{location.replace("https://www.bilibili.com")},2e3)}else u.dialog(e.message)}))}),t.querySelector("button[type=button]").addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),u.xdialog()})}))}return t.includes("/x/passport-login/web/qrcode/poll")&&null==box?.qrcode&&(box.qrcode=1,e=new Response('{"code":2,"message":"timeout"}')),e})}))}